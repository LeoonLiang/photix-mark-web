<template>
  <!-- æœªä¸Šä¼ çŠ¶æ€ï¼šæ¬¢è¿é¡µ -->
  <div v-if="uploadedFiles.length === 0" class="relative min-h-screen bg-background flex items-center justify-center p-4 overflow-hidden">
    <!-- Background Image -->
    <div class="absolute inset-0 z-0">
      <img src="/demo.jpg" alt="Showcase" class="w-full h-full object-cover blur-sm opacity-20">
      <div class="absolute inset-0 bg-background/50"></div>
    </div>
    
    <div class="relative z-10 max-w-2xl w-full bg-background/50 backdrop-blur-md p-8 rounded-2xl border border-border animate-fade-in-up">
      <!-- Logo & Title -->
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-primary to-amber-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-2xl shadow-primary/20">
          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h1 class="text-5xl font-bold text-foreground mb-2">Photix Mark</h1>
        <p class="text-lg text-muted-foreground">ä¸ºä½ çš„æ‘„å½±ä½œå“ï¼Œä¼˜é›…åœ°é™„ä¸Šä¸“å±æ°´å°ä¸å‚æ•°ã€‚</p>
      </div>

      <!-- Features -->
      <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="text-center p-4">
          <div class="w-12 h-12 bg-card/80 rounded-lg flex items-center justify-center mx-auto mb-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <p class="text-sm text-foreground font-medium">éšç§å®‰å…¨</p>
          <p class="text-xs text-muted-foreground">æœ¬åœ°å¤„ç†</p>
        </div>
        <div class="text-center p-4">
          <div class="w-12 h-12 bg-card/80 rounded-lg flex items-center justify-center mx-auto mb-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
          </div>
          <p class="text-sm text-foreground font-medium">æ‰¹é‡å¤„ç†</p>
          <p class="text-xs text-muted-foreground">ä¸€é”®æ·»åŠ æ°´å°</p>
        </div>
        <div class="text-center p-4">
          <div class="w-12 h-12 bg-card/80 rounded-lg flex items-center justify-center mx-auto mb-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
          </div>
          <p class="text-sm text-foreground font-medium">å®æ—¶é¢„è§ˆ</p>
          <p class="text-xs text-muted-foreground">å³æ—¶æŸ¥çœ‹æ•ˆæœ</p>
        </div>
      </div>

      <!-- Upload Card -->
      <Card class="bg-card/80 backdrop-blur-xl shadow-2xl shadow-primary/10">
            <ImageUploader @upload="handleUpload" />
      </Card>
    </div>
  </div>

  <!-- å·²ä¸Šä¼ çŠ¶æ€ï¼šç¼–è¾‘å™¨ -->
  <div v-else class="h-screen flex flex-col bg-background overflow-hidden">
    <!-- Header - æ¡Œé¢ç«¯ -->
    <header class="bg-background/80 backdrop-blur-xl border-b border-border h-16 flex-shrink-0 items-center px-6 shadow-sm hidden lg:flex">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-primary to-amber-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <h1 class="font-bold text-lg text-foreground tracking-tight">Photix Mark</h1>
          <p class="text-xs text-muted-foreground">{{ uploadedFiles.length }} å¼ å›¾ç‰‡</p>
        </div>
      </div>

      <div class="ml-auto">
        <Button @click="resetApp" variant="outline" size="sm">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          é‡æ–°é€‰æ‹©
        </Button>
      </div>
    </header>

    <!-- Mobile Header - ç§»åŠ¨ç«¯ç®€åŒ–ç‰ˆ -->
    <header class="bg-background/95 backdrop-blur-xl border-b border-border h-12 flex-shrink-0 flex items-center justify-between px-3 shadow-sm lg:hidden">
      <!-- è¿”å›æŒ‰é’® -->
      <button @click="resetApp" class="p-2 hover:bg-muted rounded-lg transition-colors">
        <svg class="w-5 h-5 text-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <!-- åº”ç”¨åˆ°å…¨éƒ¨æŒ‰é’® -->
      <Button
        @click="applyToAll"
        :disabled="processing || currentTemplateId === 'noProcess'"
        variant="secondary"
        size="sm"
        class="text-xs px-3 py-1.5 rounded-full"
      >
        åº”ç”¨åˆ°å…¨éƒ¨
      </Button>

      <!-- å¯¼å‡ºæŒ‰é’® -->
      <Button
        @click="downloadAll"
        variant="default"
        size="sm"
        class="text-xs px-3 py-1.5 font-medium"
      >
        å¯¼å‡ºå…¨éƒ¨
      </Button>
    </header>

    <!-- Main Editor - æ¡Œé¢ç«¯ -->
    <main class="flex-1 hidden lg:block" style="min-height: 0; overflow: hidden; padding: 16px;">
      <div class="h-full grid grid-cols-12" style="gap: 16px;">
        <!-- Left: Image Carousel (70%) -->
        <div class="col-span-12 lg:col-span-8" style="min-height: 0;">
          <div class="h-full bg-card/80 backdrop-blur-xl shadow-lg shadow-primary/5 rounded-lg" style="overflow: hidden; padding: 12px;">
            <ClientOnly>
              <ImageCarousel
                :files="uploadedFiles"
                :current-index="currentIndex"
                :processors="currentTemplate.processors"
                :user-config="currentConfig"
                :preview-urls="previewUrls"
                :custom-logos="customLogos"
                :exif-cache="exifCache"
                @update:current-index="currentIndex = $event"
              />
            </ClientOnly>
          </div>
        </div>

        <!-- Right: Control Panel (30%) -->
        <div class="col-span-12 lg:col-span-4" style="min-height: 0; overflow: hidden;">
          <div class="h-full overflow-y-auto space-y-4" style="padding-right: 4px;">
          <!-- Template Selection -->
          <Card class="bg-card/80 backdrop-blur-xl shadow-lg shadow-primary/5">
            <CardHeader class="border-b bg-black/10 py-3">
              <CardTitle class="text-base">æ¨¡æ¿é€‰æ‹©</CardTitle>
            </CardHeader>
            <CardContent>
              <TemplateSelector
                :templates="templates"
                :selected-id="currentTemplateId"
                @select="handleTemplateSelect"
              />
            </CardContent>
          </Card>

          <!-- Template Configuration -->
          <Card v-if="currentTemplateId !== 'noProcess'" class="bg-card/80 backdrop-blur-xl shadow-lg shadow-primary/5">
            <CardHeader class="border-b bg-black/10 py-3">
              <CardTitle class="text-base">æ¨¡æ¿é…ç½®</CardTitle>
            </CardHeader>
            <CardContent>
              <TemplateConfig
                :template="currentTemplate"
                :exif="currentExif"
                v-model="currentConfig"
              />
            </CardContent>
          </Card>

          <!-- Brand Logo Manager -->
          <Card v-if="uploadedFiles.length > 0" class="bg-card/80 backdrop-blur-xl shadow-lg shadow-primary/5">
            <CardHeader class="border-b bg-black/10 py-3">
              <CardTitle class="text-base">å“ç‰Œ Logo</CardTitle>
            </CardHeader>
            <CardContent>
              <BrandLogoManager
                :brands="brandStats"
                :no-brand-count="noBrandCount"
                :custom-logos="customLogos"
                @update:custom-logos="customLogos = $event"
                @logo-uploaded="handleLogoUploaded"
              />
            </CardContent>
          </Card>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <!-- Apply Buttons -->
            <div class="space-y-2">
              <Button
                @click="applyToAll"
                :disabled="processing || currentTemplateId === 'noProcess'"
                class="w-full"
                size="lg"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
              </Button>

              <Button
                @click="applyToSelected"
                :disabled="processing || currentTemplateId === 'noProcess'"
                variant="outline"
                class="w-full"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                åº”ç”¨åˆ°éƒ¨åˆ†å›¾ç‰‡
              </Button>
            </div>

            <!-- Download Buttons -->
            <div class="space-y-2 pt-2 border-t">
              <Button
                @click="downloadCurrent"
                variant="secondary"
                class="w-full"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                å¯¼å‡ºå½“å‰å›¾ç‰‡
              </Button>

              <Button
                @click="downloadAll"
                variant="secondary"
                class="w-full"
              >
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                </svg>
                å¯¼å‡ºå…¨éƒ¨å›¾ç‰‡
              </Button>
            </div>
          </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Mobile Main - ç§»åŠ¨ç«¯å¸ƒå±€ -->
    <main class="flex-1 lg:hidden flex flex-col relative bg-muted/30" style="min-height: 0; overflow: hidden;">
      <!-- Preview Area -->
      <div class="flex-1" style="min-height: 0; padding: 4px;">
        <div class="h-full bg-card/90 backdrop-blur-xl shadow-lg rounded-lg" style="overflow: hidden; padding: 6px;">
          <ClientOnly>
            <ImageCarousel
              :files="uploadedFiles"
              :current-index="currentIndex"
              :processors="currentTemplate.processors"
              :user-config="currentConfig"
              :preview-urls="previewUrls"
              :custom-logos="customLogos"
              :exif-cache="exifCache"
              @update:current-index="currentIndex = $event"
            />
          </ClientOnly>
        </div>
      </div>

      <!-- Bottom Control Tabs -->
      <div class="flex-shrink-0 bg-background/95 backdrop-blur-xl border-t border-border">
        <!-- Tab Content -->
        <div class="overflow-y-auto" style="max-height: 50vh;">
          <!-- æ¨¡æ¿é€‰æ‹© Tab -->
          <div v-show="currentMobileTab === 'template'" class="px-3 pt-2 pb-3 space-y-2">
            <TemplateSelector
              :templates="templates"
              :selected-id="currentTemplateId"
              @select="handleTemplateSelect"
            />

            <!-- Template Configuration -->
            <TemplateConfig
              v-if="currentTemplateId !== 'noProcess'"
              :template="currentTemplate"
              :exif="currentExif"
              v-model="currentConfig"
            />
          </div>

          <!-- å“ç‰Œç®¡ç† Tab -->
          <div v-show="currentMobileTab === 'brand'" class="px-3 pt-2 pb-3">
            <BrandLogoManager
              :brands="brandStats"
              :no-brand-count="noBrandCount"
              :custom-logos="customLogos"
              @update:custom-logos="customLogos = $event"
              @logo-uploaded="handleLogoUploaded"
            />
          </div>

          <!-- åº”ç”¨ Tab -->
          <div v-show="currentMobileTab === 'apply'" class="p-3 space-y-2">
            <Button
              @click="applyToAll"
              :disabled="processing || currentTemplateId === 'noProcess'"
              class="w-full"
              size="lg"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
            </Button>

            <Button
              @click="applyToSelected"
              :disabled="processing || currentTemplateId === 'noProcess'"
              variant="outline"
              class="w-full"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              åº”ç”¨åˆ°éƒ¨åˆ†å›¾ç‰‡
            </Button>
          </div>

          <!-- å¯¼å‡º Tab -->
          <div v-show="currentMobileTab === 'export'" class="p-3 space-y-2">
            <Button
              @click="downloadCurrent"
              variant="secondary"
              class="w-full"
              size="lg"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              å¯¼å‡ºå½“å‰å›¾ç‰‡
            </Button>

            <Button
              @click="downloadAll"
              variant="secondary"
              class="w-full"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
              </svg>
              å¯¼å‡ºå…¨éƒ¨å›¾ç‰‡
            </Button>
          </div>
        </div>

        <!-- Bottom Icon Navigation -->
        <div class="border-t border-border bg-background">
          <div class="flex items-center justify-around px-2 py-2 safe-area-inset-bottom">
            <button
              v-for="tab in mobileTabs"
              :key="tab.id"
              @click="currentMobileTab = tab.id"
              :class="[
                'flex flex-col items-center justify-center gap-1 px-4 py-1.5 rounded-lg transition-all min-w-[64px]',
                currentMobileTab === tab.id
                  ? 'text-primary'
                  : 'text-muted-foreground'
              ]"
            >
              <component :is="tab.icon" class="w-5 h-5" />
              <span class="text-[10px] font-medium">{{ tab.label }}</span>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Processing Progress Modal -->
  <ProcessingProgress
    v-if="processing || downloading"
    :progress="processing ? progress : downloadProgress"
  />

  <!-- Image Selector Modal -->
  <ImageSelector
    v-if="showImageSelector"
    :files="uploadedFiles"
    @close="showImageSelector = false"
    @confirm="handleApplyToSelected"
  />
</template>

<script setup lang="ts">
import { ref, watch, computed, defineComponent } from 'vue'
import { useTemplates } from '~/composables/useTemplates'
import { useBatchProcessor } from '~/composables/useBatchProcessor'
import { useImageProcessor } from '~/composables/useImageProcessor'
import { useToast } from '~/composables/useToast'
import { useConfirm } from '~/composables/useConfirm'
import { useExif } from '~/composables/useExif'
import { downloadImages } from '~/utils/download'
import { canvasToBlob } from '~/utils/canvas'
import { initProcessors } from '~/lib/processors'
import type { TemplateConfig } from '~/lib/templates/types'
import Button from '~/components/ui/Button.vue'
import Card from '~/components/ui/Card.vue'
import CardHeader from '~/components/ui/CardHeader.vue'
import CardTitle from '~/components/ui/CardTitle.vue'
import CardContent from '~/components/ui/CardContent.vue'
import ImageSelector from '~/components/ImageSelector.vue'
import BrandLogoManager from '~/components/BrandLogoManager.vue'

// Toast notifications
const { success, error: showError, info } = useToast()

// Confirm dialog
const { confirm } = useConfirm()

// EXIF è¯»å–
const { readExif } = useExif()

// å›¾ç‰‡çŠ¶æ€æ¥å£
interface ImageState {
  templateId: string
  config: Record<string, any>
}

// å¤„ç†ç»“æœç¼“å­˜æ¥å£
interface ProcessedResult {
  canvas: HTMLCanvasElement
  blob: Blob
}

// ç¦ç”¨ SSR
definePageMeta({
  ssr: false
})

// åˆå§‹åŒ–å¤„ç†å™¨
onMounted(() => {
  initProcessors()
})

// æ¨¡æ¿ç®¡ç†
const { templates } = useTemplates()

// ä¸Šä¼ çš„æ–‡ä»¶
const uploadedFiles = ref<File[]>([])

// å½“å‰é¢„è§ˆç´¢å¼•
const currentIndex = ref(0)

// æ¯å¼ å›¾ç‰‡çš„ç‹¬ç«‹çŠ¶æ€ï¼ˆæ¨¡æ¿ + é…ç½®ï¼‰
const imageStates = ref<Map<File, ImageState>>(new Map())

// å¤„ç†ç»“æœç¼“å­˜ï¼ˆç”¨äºä¸‹è½½æ—¶é¿å…é‡å¤å¤„ç†ï¼‰
const processedCache = ref<Map<File, ProcessedResult>>(new Map())

// é¢„è§ˆURLç¼“å­˜ï¼ˆç”¨äºå¿«é€Ÿåˆ‡æ¢æ˜¾ç¤ºï¼‰
const previewUrls = ref<Map<File, string>>(new Map())

// EXIF æ•°æ®ç¼“å­˜
const exifCache = ref<Map<File, Record<string, any>>>(new Map())

// å½“å‰å›¾ç‰‡çš„ EXIFï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
const currentExif = ref<Record<string, any>>({})

// å“ç‰Œç»Ÿè®¡å’ŒLogoç®¡ç†
const brandStats = ref<Map<string, number>>(new Map())  // å“ç‰Œå -> å›¾ç‰‡æ•°é‡
const noBrandCount = ref(0)  // æ²¡æœ‰å“ç‰Œä¿¡æ¯çš„å›¾ç‰‡æ•°é‡
const customLogos = ref<Map<string, string>>(new Map())  // å“ç‰Œå -> è‡ªå®šä¹‰Logoçš„DataURL

// å½“å‰å›¾ç‰‡çš„æ¨¡æ¿IDï¼ˆç”¨äºUIç»‘å®šï¼‰
const currentTemplateId = ref('noProcess')

// å½“å‰å›¾ç‰‡çš„é…ç½®ï¼ˆç”¨äºUIç»‘å®šï¼‰
const currentConfig = ref<Record<string, any>>({})

// æ ¹æ®IDè·å–æ¨¡æ¿å¯¹è±¡
const currentTemplate = computed<TemplateConfig>(() => {
  return templates.value.find(t => t.id === currentTemplateId.value) || templates.value[0]
})

// æ‰¹é‡å¤„ç†
const { processBatch, processing, progress } = useBatchProcessor()
const { processImage } = useImageProcessor()

// è·å–Logo URLï¼ˆä¼˜å…ˆè‡ªå®šä¹‰Logoï¼‰
function getLogoUrl(brand: string | undefined): string | undefined {
  // 1. å¦‚æœæœ‰å“ç‰Œï¼Œæ£€æŸ¥è¯¥å“ç‰Œçš„è‡ªå®šä¹‰Logo
  if (brand && brand.trim()) {
    const trimmedBrand = brand.trim()
    if (customLogos.value.has(trimmedBrand)) {
      return customLogos.value.get(trimmedBrand)
    }
  }

  // 2. å¦‚æœæ²¡æœ‰å“ç‰Œæˆ–æ²¡æœ‰è¯¥å“ç‰Œçš„è‡ªå®šä¹‰Logoï¼Œæ£€æŸ¥é»˜è®¤Logo
  if (customLogos.value.has('')) {
    return customLogos.value.get('')
  }

  // 3. è¿”å› undefinedï¼Œè®© watermark å¤„ç†å™¨ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é€»è¾‘
  return undefined
}

// ä¸‹è½½è¿›åº¦ï¼ˆç‹¬ç«‹äºæ‰¹é‡å¤„ç†è¿›åº¦ï¼‰
const downloading = ref(false)
const downloadProgress = ref({ current: 0, total: 0, percent: 0 })

// å›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
const showImageSelector = ref(false)

// ç§»åŠ¨ç«¯ Tab çŠ¶æ€
const currentMobileTab = ref('template')

// ç§»åŠ¨ç«¯ Tab é…ç½®
const mobileTabs = [
  {
    id: 'template',
    label: 'æ¨¡æ¿',
    icon: defineComponent({
      template: `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z" />
        </svg>
      `
    })
  },
  {
    id: 'brand',
    label: 'å“ç‰Œ',
    icon: defineComponent({
      template: `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      `
    })
  },
  {
    id: 'apply',
    label: 'åº”ç”¨',
    icon: defineComponent({
      template: `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
      `
    })
  },
  {
    id: 'export',
    label: 'å¯¼å‡º',
    icon: defineComponent({
      template: `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
      `
    })
  }
]

// å¤„ç†ä¸Šä¼  - ä¸ºæ¯å¼ å›¾ç‰‡åˆå§‹åŒ–é»˜è®¤çŠ¶æ€
async function handleUpload(files: File[]) {
  uploadedFiles.value = files
  currentIndex.value = 0

  // æ¸…é™¤æ—§çš„çŠ¶æ€å’Œç¼“å­˜
  imageStates.value.clear()
  processedCache.value.clear()
  previewUrls.value.clear()
  exifCache.value.clear()
  brandStats.value.clear()
  noBrandCount.value = 0

  // ä¸ºæ‰€æœ‰æ–°å›¾ç‰‡åˆå§‹åŒ–é»˜è®¤çŠ¶æ€å¹¶è¯»å– EXIF
  for (const file of files) {
    imageStates.value.set(file, {
      templateId: 'noProcess',
      config: {}
    })

    // å¼‚æ­¥è¯»å– EXIF
    try {
      const exif = await readExif(file)
      exifCache.value.set(file, exif)

      // ç»Ÿè®¡å“ç‰Œ
      if (exif.Make && exif.Make.trim()) {
        const brand = exif.Make.trim()
        brandStats.value.set(brand, (brandStats.value.get(brand) || 0) + 1)
      } else {
        noBrandCount.value++
      }
    } catch (error) {
      console.error('Failed to read EXIF:', error)
      exifCache.value.set(file, {})
      noBrandCount.value++
    }
  }

  // åŠ è½½ç¬¬ä¸€å¼ å›¾ç‰‡çš„çŠ¶æ€
  loadCurrentImageState()
}

// åŠ è½½å½“å‰å›¾ç‰‡çš„çŠ¶æ€åˆ°UI
function loadCurrentImageState() {
  const currentFile = uploadedFiles.value[currentIndex.value]
  if (!currentFile) return

  const state = imageStates.value.get(currentFile)
  if (state) {
    // åªæœ‰å½“çŠ¶æ€çœŸçš„ä¸åŒæ—¶æ‰æ›´æ–°ï¼ˆé¿å…è§¦å‘ä¸å¿…è¦çš„ watchï¼‰
    if (currentTemplateId.value !== state.templateId) {
      currentTemplateId.value = state.templateId
    }
    if (JSON.stringify(currentConfig.value) !== JSON.stringify(state.config)) {
      currentConfig.value = { ...state.config }
    }
  }

  // åŠ è½½å½“å‰å›¾ç‰‡çš„ EXIF
  const exif = exifCache.value.get(currentFile)
  if (exif) {
    currentExif.value = exif
  } else {
    currentExif.value = {}
  }
}

// ä¿å­˜å½“å‰UIçŠ¶æ€åˆ°å½“å‰å›¾ç‰‡
function saveCurrentImageState() {
  const currentFile = uploadedFiles.value[currentIndex.value]
  if (!currentFile) return

  imageStates.value.set(currentFile, {
    templateId: currentTemplateId.value,
    config: { ...currentConfig.value }
  })
}

// ç›‘å¬ç´¢å¼•å˜åŒ–ï¼Œåˆ‡æ¢å›¾ç‰‡æ—¶åŠ è½½è¯¥å›¾ç‰‡çš„çŠ¶æ€
watch(currentIndex, () => {
  loadCurrentImageState()
})

// ç›‘å¬æ¨¡æ¿é€‰æ‹©å˜åŒ–ï¼Œä¿å­˜åˆ°å½“å‰å›¾ç‰‡çŠ¶æ€
watch(currentTemplateId, () => {
  const currentFile = uploadedFiles.value[currentIndex.value]
  if (currentFile) {
    // æ¨¡æ¿å˜åŒ–ï¼Œæ¸…é™¤è¯¥å›¾ç‰‡çš„ç¼“å­˜
    processedCache.value.delete(currentFile)
    previewUrls.value.delete(currentFile)
  }
  saveCurrentImageState()
})

// ç›‘å¬é…ç½®å˜åŒ–ï¼Œä¿å­˜åˆ°å½“å‰å›¾ç‰‡çŠ¶æ€
watch(currentConfig, () => {
  const currentFile = uploadedFiles.value[currentIndex.value]
  if (currentFile) {
    // é…ç½®å˜åŒ–ï¼Œæ¸…é™¤è¯¥å›¾ç‰‡çš„ç¼“å­˜
    processedCache.value.delete(currentFile)
    previewUrls.value.delete(currentFile)
  }
  saveCurrentImageState()

  // ğŸ”§ ä¿®å¤ï¼šåŒæ­¥é…ç½®åˆ°æ‰€æœ‰ä½¿ç”¨ç›¸åŒæ¨¡æ¿çš„å…¶ä»–å›¾ç‰‡
  const currentTemplateIdValue = currentTemplateId.value
  uploadedFiles.value.forEach(file => {
    if (file === currentFile) return // è·³è¿‡å½“å‰å›¾ç‰‡ï¼ˆå·²ä¿å­˜ï¼‰

    const state = imageStates.value.get(file)
    if (state && state.templateId === currentTemplateIdValue) {
      // ç›¸åŒæ¨¡æ¿çš„å›¾ç‰‡ï¼ŒåŒæ­¥é…ç½®
      imageStates.value.set(file, {
        templateId: state.templateId,
        config: { ...currentConfig.value }
      })
      // æ¸…é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡åˆ‡æ¢æ—¶ä¼šé‡æ–°ç”Ÿæˆ
      processedCache.value.delete(file)
      previewUrls.value.delete(file)
    }
  })
}, { deep: true })

// ç›‘å¬è‡ªå®šä¹‰Logoå˜åŒ–ï¼Œè§¦å‘é¢„è§ˆæ›´æ–°
watch(customLogos, () => {
  // Logoå˜åŒ–æ—¶ï¼Œè§¦å‘å½“å‰å›¾ç‰‡é¢„è§ˆçš„å¾®å°å˜åŒ–ï¼Œè®© ImageCarousel é‡æ–°ç”Ÿæˆé¢„è§ˆ
  // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œæ¸…é™¤ç¼“å­˜ï¼Œå› ä¸º handleLogoUploaded ä¼šå¤„ç†é‡æ–°ç”Ÿæˆ
  currentConfig.value = { ...currentConfig.value, _logoUpdateTrigger: Date.now() }
}, { deep: true })

// å¤„ç†Logoä¸Šä¼ æˆåŠŸ
async function handleLogoUploaded(brand: string) {
  const brandName = brand || 'æ— å“ç‰Œ'

  // æ‰¾å‡ºæ‰€æœ‰éœ€è¦é‡æ–°å¤„ç†çš„å›¾ç‰‡
  const filesToReprocess: File[] = []

  for (const file of uploadedFiles.value) {
    const state = imageStates.value.get(file)
    const exif = exifCache.value.get(file)
    const fileBrand = exif?.Make?.trim()

    // è·³è¿‡æœªå¤„ç†çš„å›¾ç‰‡
    if (!state || state.templateId === 'noProcess') {
      continue
    }

    // æ£€æŸ¥æ˜¯å¦åŒ¹é…è¯¥å“ç‰Œ
    if (brand === '') {
      // é»˜è®¤Logoï¼šåŒ¹é…æ— å“ç‰Œçš„å›¾ç‰‡
      if (!fileBrand) {
        filesToReprocess.push(file)
      }
    } else {
      // ç‰¹å®šå“ç‰ŒLogoï¼šåŒ¹é…è¯¥å“ç‰Œçš„å›¾ç‰‡
      if (fileBrand === brand) {
        filesToReprocess.push(file)
      }
    }
  }

  if (filesToReprocess.length === 0) {
    success(`${brandName} Logo å·²æ›´æ–°`)
    return
  }

  success(`${brandName} Logo å·²æ›´æ–°ï¼Œæ­£åœ¨é‡æ–°å¤„ç† ${filesToReprocess.length} å¼ å›¾ç‰‡...`)

  // é€ä¸ªé‡æ–°å¤„ç†è¿™äº›å›¾ç‰‡ï¼ˆå› ä¸ºæ¯ä¸ªå›¾ç‰‡å¯èƒ½ç”¨ä¸åŒæ¨¡æ¿ï¼‰
  try {
    let processedCount = 0

    for (const file of filesToReprocess) {
      const state = imageStates.value.get(file)
      if (!state) continue

      const template = templates.value.find(t => t.id === state.templateId)
      if (!template) continue

      // è·å–è‡ªå®šä¹‰Logoé…ç½®
      const exif = exifCache.value.get(file)
      const fileBrand = exif?.Make?.trim()

      const configWithLogo = {
        ...state.config,
        customLogoUrl: fileBrand && customLogos.value.has(fileBrand) ? customLogos.value.get(fileBrand) : undefined,
        customDefaultLogoUrl: customLogos.value.get('')
      }

      try {
        const canvas = await processImage(file, template.processors, configWithLogo)
        const blob = await canvasToBlob(canvas)

        // æ›´æ–°ç¼“å­˜
        processedCache.value.set(file, { canvas, blob })

        // ç”Ÿæˆé¢„è§ˆ URL
        const previewUrl = canvas.toDataURL('image/jpeg', 0.8)
        previewUrls.value.set(file, previewUrl)

        processedCount++
      } catch (error) {
        console.error(`Failed to reprocess ${file.name}:`, error)
      }
    }

    success(`${brandName} Logo å·²åº”ç”¨åˆ° ${processedCount} å¼ å›¾ç‰‡`)
  } catch (error) {
    console.error('Reprocess error:', error)
    showError('é‡æ–°å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// é‡ç½®åº”ç”¨
async function resetApp() {
  const confirmed = await confirm({
    title: 'é‡æ–°å¼€å§‹',
    message: 'ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰çš„ç¼–è¾‘å°†ä¸¢å¤±ã€‚',
    confirmText: 'é‡æ–°å¼€å§‹',
    cancelText: 'å–æ¶ˆ'
  })

  if (confirmed) {
    uploadedFiles.value = []
    currentIndex.value = 0
    imageStates.value.clear()
    processedCache.value.clear()
    previewUrls.value.clear()
    exifCache.value.clear()
    brandStats.value.clear()
    noBrandCount.value = 0
    customLogos.value.clear()
    currentTemplateId.value = 'noProcess'
    currentConfig.value = {}
    currentExif.value = {}
  }
}

// å¤„ç†æ¨¡æ¿é€‰æ‹©
function handleTemplateSelect(id: string) {
  currentTemplateId.value = id
  // åˆ‡æ¢æ¨¡æ¿æ—¶é‡ç½®é…ç½®
  currentConfig.value = {}
}

// åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡ - å°†å½“å‰æ¨¡æ¿å’Œé…ç½®åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡å¹¶ç«‹å³æ‰¹é‡å¤„ç†
async function applyToAll() {
  const confirmed = await confirm({
    title: 'åº”ç”¨åˆ°å…¨éƒ¨å›¾ç‰‡',
    message: `ç¡®å®šè¦å°†å½“å‰æ¨¡æ¿åº”ç”¨åˆ°å…¨éƒ¨ ${uploadedFiles.value.length} å¼ å›¾ç‰‡å—ï¼Ÿ`,
    confirmText: 'åº”ç”¨',
    cancelText: 'å–æ¶ˆ'
  })

  if (!confirmed) {
    return
  }

  // 1. å°†å½“å‰çŠ¶æ€åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡
  uploadedFiles.value.forEach(file => {
    imageStates.value.set(file, {
      templateId: currentTemplateId.value,
      config: { ...currentConfig.value }
    })
  })

  // 2. å¦‚æœæ˜¯"ä¸å¤„ç†"æ¨¡æ¿ï¼Œæ¸…é™¤æ‰€æœ‰å¤„ç†ç¼“å­˜
  if (currentTemplateId.value === 'noProcess') {
    processedCache.value.clear()
    previewUrls.value.clear()
    success('å·²åº”ç”¨åˆ°æ‰€æœ‰å›¾ç‰‡ï¼')
    return
  }

  // 3. æ‰¹é‡å¤„ç†æ‰€æœ‰å›¾ç‰‡å¹¶ç¼“å­˜ç»“æœ
  try {
    const results = await processBatch(
      uploadedFiles.value,
      currentTemplate.value.processors,
      currentConfig.value,
      (file) => {
        // ä¸ºæ¯ä¸ªæ–‡ä»¶æä¾›è‡ªå®šä¹‰Logoé…ç½®
        const exif = exifCache.value.get(file)
        const brand = exif?.Make?.trim()

        return {
          // å“ç‰ŒLogoï¼šä»…è¿”å›è¯¥å“ç‰Œçš„è‡ªå®šä¹‰Logoï¼ˆä¸å«é»˜è®¤ï¼‰
          customLogoUrl: brand && customLogos.value.has(brand) ? customLogos.value.get(brand) : undefined,
          // é»˜è®¤Logoï¼šç”¨äºæ— å“ç‰Œæ—¶
          customDefaultLogoUrl: customLogos.value.get('')
        }
      }
    )

    // ç¼“å­˜å¤„ç†ç»“æœå’Œé¢„è§ˆURL
    results.forEach(result => {
      processedCache.value.set(result.file, {
        canvas: result.canvas,
        blob: result.blob
      })

      // ç”Ÿæˆé¢„è§ˆ URLï¼ˆData URLï¼‰
      const previewUrl = result.canvas.toDataURL('image/jpeg', 0.8)
      previewUrls.value.set(result.file, previewUrl)
    })

    success('å¤„ç†å®Œæˆï¼æ‰€æœ‰å›¾ç‰‡å·²åº”ç”¨æ¨¡æ¿ã€‚')
  } catch (error) {
    console.error('Processing error:', error)
    showError('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// åº”ç”¨åˆ°éƒ¨åˆ†å›¾ç‰‡
function applyToSelected() {
  showImageSelector.value = true
}

// å¤„ç†é€‰ä¸­çš„å›¾ç‰‡
async function handleApplyToSelected(selectedFiles: File[]) {
  showImageSelector.value = false

  if (selectedFiles.length === 0) return

  const confirmed = await confirm({
    title: 'åº”ç”¨åˆ°é€‰ä¸­å›¾ç‰‡',
    message: `ç¡®å®šè¦å°†å½“å‰æ¨¡æ¿åº”ç”¨åˆ°é€‰ä¸­çš„ ${selectedFiles.length} å¼ å›¾ç‰‡å—ï¼Ÿ`,
    confirmText: 'åº”ç”¨',
    cancelText: 'å–æ¶ˆ'
  })

  if (!confirmed) {
    return
  }

  // 1. å°†å½“å‰çŠ¶æ€åº”ç”¨åˆ°é€‰ä¸­çš„å›¾ç‰‡
  selectedFiles.forEach(file => {
    imageStates.value.set(file, {
      templateId: currentTemplateId.value,
      config: { ...currentConfig.value }
    })
  })

  // 2. å¦‚æœæ˜¯"ä¸å¤„ç†"æ¨¡æ¿ï¼Œæ¸…é™¤é€‰ä¸­å›¾ç‰‡çš„å¤„ç†ç¼“å­˜
  if (currentTemplateId.value === 'noProcess') {
    selectedFiles.forEach(file => {
      processedCache.value.delete(file)
      previewUrls.value.delete(file)
    })
    success('å·²åº”ç”¨åˆ°é€‰ä¸­çš„å›¾ç‰‡ï¼')
    return
  }

  // 3. æ‰¹é‡å¤„ç†é€‰ä¸­çš„å›¾ç‰‡å¹¶ç¼“å­˜ç»“æœ
  try {
    const results = await processBatch(
      selectedFiles,
      currentTemplate.value.processors,
      currentConfig.value,
      (file) => {
        // ä¸ºæ¯ä¸ªæ–‡ä»¶æä¾›è‡ªå®šä¹‰Logoé…ç½®
        const exif = exifCache.value.get(file)
        const brand = exif?.Make?.trim()

        return {
          customLogoUrl: brand && customLogos.value.has(brand) ? customLogos.value.get(brand) : undefined,
          customDefaultLogoUrl: customLogos.value.get('')
        }
      }
    )

    // ç¼“å­˜å¤„ç†ç»“æœå’Œé¢„è§ˆURL
    results.forEach(result => {
      processedCache.value.set(result.file, {
        canvas: result.canvas,
        blob: result.blob
      })

      // ç”Ÿæˆé¢„è§ˆ URLï¼ˆData URLï¼‰
      const previewUrl = result.canvas.toDataURL('image/jpeg', 0.8)
      previewUrls.value.set(result.file, previewUrl)
    })

    success(`å¤„ç†å®Œæˆï¼å·²åº”ç”¨åˆ° ${selectedFiles.length} å¼ å›¾ç‰‡ã€‚`)
  } catch (error) {
    console.error('Processing error:', error)
    showError('å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// ä¸‹è½½å½“å‰å›¾ç‰‡
async function downloadCurrent() {
  try {
    const currentFile = uploadedFiles.value[currentIndex.value]
    const state = imageStates.value.get(currentFile)
    if (!state) return

    let blob: Blob

    // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
    const cached = processedCache.value.get(currentFile)
    if (cached) {
      blob = cached.blob
    } else {
      // æ²¡æœ‰ç¼“å­˜åˆ™é‡æ–°å¤„ç†
      const template = templates.value.find(t => t.id === state.templateId)
      if (!template) return

      // è·å–è‡ªå®šä¹‰Logoé…ç½®
      const exif = exifCache.value.get(currentFile)
      const brand = exif?.Make?.trim()

      const configWithLogo = {
        ...state.config,
        customLogoUrl: brand && customLogos.value.has(brand) ? customLogos.value.get(brand) : undefined,
        customDefaultLogoUrl: customLogos.value.get('')
      }

      const canvas = await processImage(
        currentFile,
        template.processors,
        configWithLogo
      )
      blob = await canvasToBlob(canvas)

      // ç¼“å­˜ç»“æœ
      processedCache.value.set(currentFile, { canvas, blob })
    }

    await downloadImages([{
      blob,
      name: currentFile.name
    }])

    success('å¯¼å‡ºæˆåŠŸï¼')
  } catch (error) {
    console.error('Download error:', error)
    showError('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// ä¸‹è½½å…¨éƒ¨å›¾ç‰‡
async function downloadAll() {
  if (uploadedFiles.value.length === 0) return

  try {
    downloading.value = true
    const results = []
    let skippedCount = 0
    let processedCount = 0

    // è®¡ç®—éœ€è¦å¤„ç†çš„å›¾ç‰‡æ€»æ•°ï¼ˆæ’é™¤ noProcessï¼‰
    const totalToProcess = uploadedFiles.value.filter(file => {
      const state = imageStates.value.get(file)
      return state && state.templateId !== 'noProcess'
    }).length

    downloadProgress.value = { current: 0, total: totalToProcess, percent: 0 }

    for (let i = 0; i < uploadedFiles.value.length; i++) {
      const file = uploadedFiles.value[i]
      const state = imageStates.value.get(file)
      if (!state) continue

      // è·³è¿‡æœªå¤„ç†çš„å›¾ç‰‡
      if (state.templateId === 'noProcess') {
        skippedCount++
        continue
      }

      let blob: Blob

      // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
      const cached = processedCache.value.get(file)
      if (cached) {
        blob = cached.blob
      } else {
        // æ²¡æœ‰ç¼“å­˜åˆ™é‡æ–°å¤„ç†
        const template = templates.value.find(t => t.id === state.templateId)
        if (!template) continue

        // è·å–è‡ªå®šä¹‰Logoé…ç½®
        const exif = exifCache.value.get(file)
        const brand = exif?.Make?.trim()

        const configWithLogo = {
          ...state.config,
          customLogoUrl: brand && customLogos.value.has(brand) ? customLogos.value.get(brand) : undefined,
          customDefaultLogoUrl: customLogos.value.get('')
        }

        const canvas = await processImage(
          file,
          template.processors,
          configWithLogo
        )
        blob = await canvasToBlob(canvas)

        // ç¼“å­˜ç»“æœ
        processedCache.value.set(file, { canvas, blob })
      }

      results.push({ blob, name: file.name })
      processedCount++

      // æ›´æ–°è¿›åº¦
      downloadProgress.value = {
        current: processedCount,
        total: totalToProcess,
        percent: totalToProcess > 0 ? Math.round((processedCount / totalToProcess) * 100) : 0
      }
    }

    // å¦‚æœæ²¡æœ‰å·²å¤„ç†çš„å›¾ç‰‡ï¼Œæç¤ºç”¨æˆ·
    if (results.length === 0) {
      showError('æ²¡æœ‰å·²å¤„ç†çš„å›¾ç‰‡å¯ä»¥å¯¼å‡º')
      return
    }

    await downloadImages(results)

    // æ ¹æ®æ˜¯å¦è·³è¿‡å›¾ç‰‡æ˜¾ç¤ºä¸åŒçš„æˆåŠŸæ¶ˆæ¯
    if (skippedCount > 0) {
      success(`æˆåŠŸå¯¼å‡º ${results.length} å¼ å›¾ç‰‡ï¼Œè·³è¿‡ ${skippedCount} å¼ æœªå¤„ç†å›¾ç‰‡`)
    } else {
      success(`æˆåŠŸå¯¼å‡º ${results.length} å¼ å›¾ç‰‡`)
    }
  } catch (error) {
    console.error('Download error:', error)
    showError('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    downloading.value = false
  }
}
</script>

<style scoped>
@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fade-in-up {
  animation: fade-in-up 0.5s ease-out forwards;
}
</style>

